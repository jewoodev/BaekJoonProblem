CREATE TABLE for_codingtest.crcrh (
	HISTORY_ID SMALLINT NOT NULL PRIMARY KEY,
	CAR_ID SMALLINT,
	START_DATE DATE,
	END_DATE DATE
)

INSERT INTO for_codingtest.crcrh VALUES (1, 4, "2022-09-27", "2022-09-27");
INSERT INTO for_codingtest.crcrh VALUES (2, 3, "2022-10-03", "2022-10-04");
INSERT INTO for_codingtest.crcrh VALUES (3, 2, "2022-10-05", "2022-10-05");
INSERT INTO for_codingtest.crcrh VALUES (4, 1, "2022-10-11", "2022-10-16");
INSERT INTO for_codingtest.crcrh VALUES (5, 3, "2022-10-13", "2022-10-15");
INSERT INTO for_codingtest.crcrh VALUES (6, 2, "2022-10-15", "2022-10-17");

USE for_codingtest;
WITH CTE1 AS (
SELECT CAR_ID, 
CASE WHEN START_DATE < '2022-10-16' AND
END_DATE > '2022-10-16' THEN "대여가능" 
ELSE "대여중" END AVAILABILITY
FROM crcrh
ORDER BY CAR_ID DESC)
, CTE2 AS (
SELECT CAR_ID,
    sum(CASE WHEN AVAILABILITY != '대여중' THEN NULL ELSE 1 END) AB1,
FROM CTE1
GROUP BY 1)
SELECT *
FROM CTE2;

WITH C1 (CAR_ID, AVAILABILITY) AS (
SELECT CAR_ID, 
CASE WHEN START_DATE < '2022-10-16' AND
END_DATE > '2022-10-16' THEN "대여가능" 
ELSE "대여중" END AVAILABILITY
FROM crcrh
ORDER BY CAR_ID DESC)
SELECT CAR_ID,
    sum(CASE WHEN AVAILABILITY != '대여중' THEN NULL ELSE 1 END) AB1,
FROM C1;


SELECT CAR_ID,
    sum(CASE WHEN AVAILABILITY != '대여중' THEN NULL ELSE 1 END) AB1
FROM (SELECT CAR_ID, 
CASE WHEN START_DATE < '2022-10-16' AND
END_DATE > '2022-10-16' THEN "대여가능" 
ELSE "대여중" END AVAILABILITY
FROM crcrh
ORDER BY CAR_ID DESC) ab;
